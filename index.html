<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Malaysia Rainfall &amp; Disaster Data 2000-2021</title>

    <!-- Vega-Lite CDN -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

    <style>
      :root {
        /* Design System Colors */
        --color-white: rgba(255, 255, 255, 1);
        --color-black: rgba(0, 0, 0, 1);
        --color-cream-50: rgba(252, 252, 249, 1);
        --color-cream-100: rgba(255, 255, 253, 1);
        --color-gray-200: rgba(245, 245, 245, 1);
        --color-gray-300: rgba(167, 169, 169, 1);
        --color-slate-500: rgba(98, 108, 113, 1);
        --color-slate-900: rgba(19, 52, 59, 1);
        --color-teal-500: rgba(33, 128, 141, 1);
        --color-teal-600: rgba(29, 116, 128, 1);

        /* Semantic Colors */
        --color-background: var(--color-gray-200);
        --color-surface: var(--color-cream-100);
        --color-text: var(--color-slate-900);
        --color-text-secondary: var(--color-slate-500);
        --color-primary: var(--color-teal-500);

        /* Typography */
        --font-family-serif: "Times New Roman", Times, serif;
        --font-family-sans: "Arial", "Helvetica", sans-serif;
        --font-size-xs: 12px;
        --font-size-sm: 14px;
        --font-size-base: 16px;
        --font-size-lg: 18px;
        --font-size-xl: 24px;
        --font-size-2xl: 32px;
        --font-size-3xl: 48px;

        /* Spacing */
        --space-4: 4px;
        --space-8: 8px;
        --space-16: 16px;
        --space-24: 24px;
        --space-32: 32px;
        --space-48: 48px;
        --space-64: 64px;

        /* Border Radius */
        --radius-base: 8px;
        --radius-lg: 12px;

        /* Shadows */
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
        --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family-sans);
        background-color: var(--color-background);
        color: var(--color-text);
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-32);
      }

      /* Main Title */
      .main-title {
        font-family: var(--font-family-serif);
        font-size: var(--font-size-3xl);
        font-weight: bold;
        text-align: center;
        margin-bottom: var(--space-64);
        color: var(--color-text);
      }

      /* Section Headers */
      .section-header {
        font-family: var(--font-family-sans);
        font-size: var(--font-size-xl);
        font-weight: 600;
        margin-bottom: var(--space-16);
      }

      .section-header--center {
        text-align: center;
      }

      .section-header--left {
        text-align: left;
      }

      .section-header--right {
        text-align: right;
      }

      /* Layout Sections */
      .section {
        margin-bottom: var(--space-64);
      }

      .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-48);
        align-items: stretch;
      }

      .two-column > * {
        display: flex;
        flex-direction: column;
      }

      .two-column > * > .vis-container,
      .two-column > * > .explanatory-text {
        flex-grow: 1;
      }

      /* Visualization Containers */
      .vis-container {
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        padding: var(--space-24);
        box-shadow: var(--shadow-sm);
        transition: box-shadow 0.3s ease;
      }

      .vis-container:hover {
        box-shadow: var(--shadow-md);
      }

      .vis-container--center {
        text-align: center;
      }

      .vis-container--left {
        text-align: left;
      }

      .vis-container--right {
        text-align: right;
      }

      /* Text Content */
      .explanatory-text {
        font-family: var(--font-family-sans);
        font-size: var(--font-size-xl);
        line-height: 1.7;
        color: var(--color-text);
        padding: var(--space-24);
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
      }

      .placeholder-text {
        font-family: var(--font-family-sans);
        font-size: var(--font-size-xl);
        line-height: 1.7;
        color: var(--color-text);
        padding: var(--space-24);
        background-color: var(--color-surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        margin-top: var(--space-32);
      }

      /* Slider Controls */
      .slider-container {
        margin: var(--space-16) 0;
        text-align: center;
      }

      .slider-label {
        font-family: var(--font-family-sans);
        font-size: var(--font-size-sm);
        font-weight: 600;
        margin-bottom: var(--space-8);
        display: block;
      }

      .year-slider {
        width: 300px;
        max-width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--color-gray-200);
        outline: none;
        -webkit-appearance: none;
      }

      .year-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-primary);
        cursor: pointer;
      }

      .year-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-primary);
        cursor: pointer;
        border: none;
      }

      .year-display {
        font-family: var(--font-family-sans);
        font-size: var(--font-size-base);
        font-weight: 600;
        margin-top: var(--space-8);
        color: var(--color-primary);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container {
          padding: var(--space-16);
        }

        .main-title {
          font-size: var(--font-size-2xl);
          margin-bottom: var(--space-32);
        }

        .section-header {
          font-size: var(--font-size-lg);
        }

        .two-column {
          grid-template-columns: 1fr;
          gap: var(--space-24);
        }

        .section {
          margin-bottom: var(--space-32);
        }
      }

      /* Animation for smooth transitions */
      .vis-container,
      .explanatory-text {
        transition:
          transform 0.3s ease,
          box-shadow 0.3s ease;
      }

      .vis-container:hover,
      .explanatory-text:hover {
        transform: translateY(-2px);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Main Title -->
      <h1 class="main-title">
        RAINFALL AND ITS EFFECT IN MALAYSIA <span style="font-size: var(--font-size-xl);">(2000 - 2021)</span>
      </h1>

      <!-- Section 1: Malaysian Rainfall Overview -->
      <div class="section">
        <h3 class="section-header section-header--center">
          MALAYSIA RAINFALL OVERVIEW ANNUALLY
        </h3>
        <div class="vis-container vis-container--center">
          <div id="vis_map"></div>
          <div class="slider-container">
            <label class="slider-label" for="year_slider_map"
              >Select Year:</label
            >
            <input
              type="range"
              id="year_slider_map"
              class="year-slider"
              min="2000"
              max="2021"
              value="2000"
              step="1"
            />
            <div id="year_display_map" class="year-display">2000</div>
          </div>
        </div>
      </div>

      <!-- Section 2: Rainfall Trend and Annual Rainfall -->
      <div class="section">
        <div class="two-column">
          <div>
            <h3 class="section-header section-header--center">
              Rainfall Trend and Impacts
            </h3>
            <div class="explanatory-text">
              Malaysia's climate has <strong>two monsoon seasons</strong>, with the <strong>Northeast Monsoon</strong> bringing heavy rainfall (<strong>over 3,000 mm</strong>) that can trigger <strong>floods and landslides</strong>. The <strong>2014 floods</strong> are a key example, displacing <strong>over 200,000 people</strong>.
            </div>
          </div>
          <div>
            <h3 class="section-header section-header--center">
              Annual Rainfall per region
            </h3>
            <div class="vis-container vis-container--right">
              <div id="vis_lollipop"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 3 & 4: Disaster and Damages -->
      <div class="section">
        <div class="two-column">
          <div>
            <h3 class="section-header section-header--center">
              Disaster Overtime
            </h3>
            <div class="vis-container vis-container--left">
              <div id="vis_donut"></div>
              <div class="slider-container">
                <label class="slider-label" for="year_slider_donut"
                  >Select Year:</label
                >
                <input
                  type="range"
                  id="year_slider_donut"
                  class="year-slider"
                  min="2000"
                  max="2021"
                  value="2000"
                  step="1"
                />
                <div id="year_display_donut" class="year-display">2000</div>
              </div>
            </div>
          </div>
          <div>
            <h3 class="section-header section-header--center">
              Damages Caused Each Year
            </h3>
            <div class="vis-container vis-container--right">
              <div id="vis_barchart_damage"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section 5: People Affected Chart -->
      <div class="section">
        <h2 class="section-header section-header--center">
          Total Number Of people Effected Each Year
        </h2>
        <div class="vis-container vis-container--center">
          <div id="vis_area"></div>
        </div>
        <div class="placeholder-text">
          The chart shows the annual number of people in Malaysia affected by natural disasters from <strong>2000-2021</strong>. Peaks, like the one in <strong>2014</strong> that affected <strong>nearly half a million people</strong>, are tied to <strong>major floods</strong>, highlighting the need for <strong>disaster preparedness</strong>.
        </div>
      </div>

      <!-- Section 6: East vs West and Rainforest Text -->
      <div class="section">
        <div class="two-column">
          <div>
            <h3 class="section-header section-header--center">
              Annual Rainfall (East vs West) Malaysia
            </h3>
            <div class="vis-container vis-container--left">
              <div id="vis_multiline_density"></div>
            </div>
          </div>
          <div>
            <h3 class="section-header section-header--center">
              Rainforest and Rainfall
            </h3>
            <div class="explanatory-text">
              <strong>East Malaysia</strong> (Sabah and Sarawak) gets <strong>20-30% more rain</strong> than Peninsular Malaysia. This is due to the <strong>Borneo rainforest</strong> and mountains, which increase humidity and rainfall, with some areas <strong>exceeding 3,500 mm</strong> annually.
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      // Map visualization
      const spec_map = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 800,
        height: 500,
        background: "#B3D9D9",
        projection: {
          type: "mercator",
          scale: 2000,
          center: [109, 4.5],
        },
        params: [
          {
            name: "year_selection",
            value: 2000,
          },
        ],
        layer: [
          {
            data: {
              url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/countries-10m.json",
              format: { type: "topojson", feature: "countries" },
            },
            transform: [
              {
                filter: {
                  field: "properties.name",
                  oneOf: [
                    "Singapore",
                    "Laos",
                    "Thailand",
                    "Cambodia",
                    "Indonesia",
                    "Philippines",
                    "Brunei Darussalam",
                    "Myanmar",
                  ],
                },
              },
            ],
            mark: { type: "geoshape", fill: "lightgray", stroke: "white" },
          },
          {
            data: {
              url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/ne_110m_graticules_1.json",
              format: { type: "topojson", feature: "ne_110m_graticules_1" },
            },
            mark: {
              type: "geoshape",
              fill: "none",
              stroke: "#E0E0E0",
              strokeOpacity: 0.5,
            },
          },
          {
            data: {
              url: "ne_10m_admin_1_states_provinces.json",
              format: {
                type: "topojson",
                feature: "ne_10m_admin_1_states_provinces",
              },
            },
            mark: { type: "geoshape", fill: "lightgray", stroke: "white" },
          },
          {
            data: { url: "processed_rainfall_data.csv" },
            transform: [
              { filter: "datum.YEAR == year_selection" },
              {
                lookup: "STATE",
                from: {
                  data: {
                    url: "ne_10m_admin_1_states_provinces.json",
                    format: {
                      type: "topojson",
                      feature: "ne_10m_admin_1_states_provinces",
                    },
                  },
                  key: "properties.name",
                },
                as: "geo",
              },
              { filter: "datum.geo != null" },
            ],
            mark: { type: "geoshape", stroke: "black" },
            encoding: {
              shape: { field: "geo", type: "geojson" },
              color: {
                field: "ANNUAL RAINFALL",
                type: "quantitative",
                scale: {
                  scheme: "blues",
                  reverse: false,
                  domain: [1500, 5000],
                },
                legend: { title: "Annual Rainfall (mm)", titleFontSize: 16, labelFontSize: 12 },
              },
              tooltip: [
                { field: "STATE", type: "nominal", title: "State" },
                {
                  field: "ANNUAL RAINFALL",
                  type: "quantitative",
                  title: "Annual Rainfall (mm)",
                  format: ".2f",
                },
                {
                  field: "NUMBER OF DAYS OF RAINFALL",
                  type: "quantitative",
                  title: "Days of rainfall",
                },
              ],
            },
          },
        ],
      };

      let lollipopView;
      let currentHoveredState = null;
      let mapView;
      let donutView;

      vegaEmbed("#vis_map", spec_map, { renderer: "svg" }).then((result) => {
        mapView = result.view;
        const slider = document.getElementById("year_slider_map");
        const label = document.getElementById("year_display_map");

        slider.addEventListener("input", () => {
          const year = parseInt(slider.value, 10);
          label.innerText = year;
          mapView.signal("year_selection", year).runAsync();
        });

        mapView.addEventListener("mouseover", (event, item) => {
          if (
            item &&
            item.datum &&
            item.datum.STATE &&
            item.datum.STATE !== currentHoveredState
          ) {
            currentHoveredState = item.datum.STATE;
            if (lollipopView) {
              lollipopView
                .signal("state_selection", currentHoveredState)
                .runAsync();
              const dropdown = document.querySelector('select[name="State"]');
              if (dropdown) {
                dropdown.value = currentHoveredState;
              }
            }
          }
        });

        mapView.addEventListener("mouseout", (event, item) => {
          if (item && item.datum && item.datum.STATE === currentHoveredState) {
            currentHoveredState = null;
            if (lollipopView) {
              lollipopView.signal("state_selection", "Malaysia").runAsync();
              const dropdown = document.querySelector('select[name="State"]');
              if (dropdown) {
                dropdown.value = "Malaysia";
              }
            }
          }
        });
      });

      const spec_donut = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 300,
        height: 400,
        data: { url: "cleaned_disaster_data.csv" },
        params: [
          {
            name: "year_selection",
            value: 2000,
          },
        ],
        layer: [
          {
            transform: [
              { filter: "datum.YEAR == year_selection" },
              {
                calculate:
                  "isValid(datum.Origin) && datum.Origin !== '' ? datum.Origin : 'No data'",
                as: "origin_tooltip",
              },
              {
                calculate:
                  "isValid(datum['Total Affected']) ? datum['Total Affected'] : 'No data'",
                as: "affected_tooltip",
              },
              {
                calculate:
                  "isValid(datum['Total Deaths']) ? datum['Total Deaths'] : 'No data'",
                as: "deaths_tooltip",
              },
            ],
            mark: { type: "arc", innerRadius: 80 },
            encoding: {
              theta: { aggregate: "count", "field": "Disaster Subtype", "type": "quantitative" },
              color: {
                field: "Disaster Subtype",
                type: "nominal",
                scale: {
                  scheme: "category10"
                },
                legend: { title: "Disaster Type", titleFontSize: 16, labelFontSize: 12 },
              },
              tooltip: [
                {
                  field: "Disaster Subtype",
                  type: "nominal",
                  title: "Disaster Type",
                },
                { field: "origin_tooltip", type: "nominal", title: "Origin" },
                {
                  field: "affected_tooltip",
                  type: "nominal",
                  title: "Total Affected",
                },
                {
                  field: "deaths_tooltip",
                  type: "nominal",
                  title: "Total Deaths",
                },
              ],
            },
          },
          {
            "transform": [
              { "filter": "datum.YEAR == year_selection" }
            ],
            "mark": {"type": "text", "radius": 110, "fill": "black"},
            "encoding": {
              "theta": {"field": "Disaster Subtype", "aggregate": "count", "type": "quantitative", "stack": true},
              "text": {"field": "Disaster Subtype", "type": "nominal"}
            }
          },
          {
            data: { url: "cleaned_disaster_data.csv" },
            transform: [
              { filter: "datum.YEAR == year_selection" },
              { aggregate: [{ op: "count", as: "disaster_count" }] },
              {
                calculate:
                  "datum.disaster_count > 0 ? year_selection : 'No data'",
                as: "display_text",
              },
              {
                calculate: "datum.disaster_count > 0 ? 40 : 16",
                as: "font_size",
              },
            ],
            mark: {
              type: "text",
              fontSize: { expr: "datum.font_size" },
              fontWeight: "bold",
            },
            encoding: {
              text: { field: "display_text", type: "nominal" },
            },
          },
          {
            data: { url: "cleaned_disaster_data.csv" },
            transform: [
              { filter: "datum.YEAR == year_selection" },
              { aggregate: [{ op: "count", as: "disaster_count" }] },
              { filter: "datum.disaster_count == 0" },
              { calculate: "'for ' + year_selection", as: "subtitle_text" },
            ],
            mark: {
              type: "text",
              dy: 20,
              fontSize: 14,
              color: "gray",
            },
            encoding: {
              text: { field: "subtitle_text", type: "nominal" },
            },
          },
        ],
      };
      vegaEmbed("#vis_donut", spec_donut, { renderer: "svg" }).then(
        (result) => {
          donutView = result.view;
          const slider = document.getElementById("year_slider_donut");
          const label = document.getElementById("year_display_donut");

          slider.addEventListener("input", () => {
            const year = parseInt(slider.value, 10);
            label.innerText = year;
            donutView.signal("year_selection", year).runAsync();
          });
        },
      );

      const spec_lollipop = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 533,
        height: 333,
        data: { url: "processed_rainfall_data.csv" },
        params: [
          {
            name: "state_selection",
            value: "Malaysia",
            bind: {
              input: "select",
              options: [
                "Malaysia",
                "Johor",
                "Kedah",
                "Kelantan",
                "Kuala Lumpur",
                "Melaka",
                "Negeri Sembilan",
                "Pahang",
                "Perak",
                "Perlis",
                "Pulau Pinang",
                "Sabah",
                "Sarawak",
                "Selangor",
                "Terengganu",
                "Wilayah Persekutuan Labuan",
              ],
              name: "State",
            },
          },
        ],
        transform: [
          {
            filter:
              "state_selection == 'Malaysia' || datum.STATE == state_selection",
          },
          {
            aggregate: [
              { op: "sum", field: "ANNUAL RAINFALL", as: "total_rainfall" },
            ],
            groupby: ["YEAR"],
          },
          {
            window: [
              { op: "max", field: "total_rainfall", as: "max_rainfall" },
            ],
            frame: [null, null],
          },
        ],
        encoding: {
          y: {
            field: "YEAR",
            type: "ordinal",
            title: "Year",
            axis: { grid: false, titleFontSize: 16, labelFontSize: 14 },
          },
          x: {
            field: "total_rainfall",
            type: "quantitative",
            title: "Total Annual Rainfall (mm)",
            axis: { grid: true, titleFontSize: 16, labelFontSize: 14 },
          },
          tooltip: [
            { field: "YEAR", type: "ordinal", title: "Year" },
            {
              field: "total_rainfall",
              type: "quantitative",
              title: "Total Rainfall (mm)",
              format: ".2f",
            },
          ],
          color: {
            condition: {
              test: "datum.total_rainfall === datum.max_rainfall",
              value: "black",
            },
            value: "steelblue",
          },
        },
        layer: [
          {
            mark: { type: "rule", size: 3 },
          },
          {
            mark: {
              type: "point",
              filled: true,
              size: 200,
            },
          },
        ],
      };
      vegaEmbed("#vis_lollipop", spec_lollipop, { actions: false }).then(
        (result) => {
          lollipopView = result.view;
        },
      );

      const spec_area = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 800,
        height: 300,
        data: { url: "cleaned_disaster_data.csv" },
        transform: [
          {
            aggregate: [
              { op: "sum", field: "Total Affected", as: "total_affected" },
            ],
            groupby: ["YEAR"],
          },
        ],
        layer: [
          {
            mark: { type: "area", opacity: 0.3 },
            encoding: {
              x: {
                field: "YEAR",
                type: "quantitative",
                title: "Year",
                axis: { format: "d", titleFontSize: 16, labelFontSize: 14 },
              },
              y: {
                field: "total_affected",
                type: "quantitative",
                title: "Total Number of People Affected",
                axis: { titleFontSize: 16, labelFontSize: 12 },
              },
            },
          },
          {
            mark: "line",
            encoding: {
              x: {
                field: "YEAR",
                type: "quantitative",
                title: "Year",
                axis: { format: "d" },
              },
              y: {
                field: "total_affected",
                type: "quantitative",
                title: "Total Number of People Affected",
              },
            },
          },
          {
            mark: "point",
            encoding: {
              x: {
                field: "YEAR",
                type: "quantitative",
                title: "Year",
                axis: { format: "d" },
              },
              y: {
                field: "total_affected",
                type: "quantitative",
                title: "Total Number of People Affected",
              },
              tooltip: [
                { field: "YEAR", type: "quantitative", title: "Year" },
                {
                  field: "total_affected",
                  type: "quantitative",
                  title: "Total Affected",
                  format: ",.0f",
                },
              ],
            },
          },
          {
            data: { values: [{ "YEAR": 2014 }] },
            mark: {
              type: "rule",
              stroke: "red",
              strokeDash: [5, 5],
              size: 2,
            },
            encoding: {
              x: { field: "YEAR", type: "quantitative" },
            },
          },
          {
            data: { values: [{"YEAR": 2014, "total_affected": 260000}] },
            mark: {
              type: "text",
              align: "right",
              baseline: "middle",
              dx: -15,
              fontSize: 14,
              text: [
                "2014 floods displaced over 200,000 people,",
                "killed at least 13, and devastated Kelantan",
                "and neighboring states with record rainfall"
              ]
            },
            encoding: {
              x: { field: "YEAR", type: "quantitative" },
              y: { field: "total_affected", type: "quantitative"}
            }
          }
        ]
      };
      vegaEmbed("#vis_area", spec_area, { actions: false });

      const spec_multiline_rainfall = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 400,
        height: 300,
        layer: [
          {
            data: { url: "cleaned_east_west.csv" },
            transform: [
              {
                fold: ["West_Avg_Rainfall", "East_Avg_Rainfall"],
                as: ["Region", "Average_Rainfall"],
              },
              {
                calculate:
                  "datum.Region == 'West_Avg_Rainfall' ? 'West Malaysia' : 'East Malaysia'",
                as: "Region",
              },
            ],
            mark: "line",
            encoding: {
              x: { field: "year", type: "quantitative", title: "Year", axis: {format: "d", titleFontSize: 16, labelFontSize: 14} },
              y: {
                field: "Average_Rainfall",
                type: "quantitative",
                title: "Average Annual Rainfall (mm)",
                axis: { titleFontSize: 16, labelFontSize: 14 },
              },
              color: { field: "Region", type: "nominal", title: "Region", legend: { titleFontSize: 16, labelFontSize: 12 } },
            },
          },
          {
            data: { url: "cleaned_east_west.csv" },
            transform: [
              {
                fold: ["West_Avg_Rainfall", "East_Avg_Rainfall"],
                as: ["Region", "Average_Rainfall"],
              },
              {
                calculate:
                  "datum.Region == 'West_Avg_Rainfall' ? 'West Malaysia' : 'East Malaysia'",
                as: "Region",
              },
            ],
            mark: {
              type: "line",
              stroke: "transparent",
              strokeWidth: 10
            },
            encoding: {
              x: { field: "year", type: "quantitative" },
              y: { field: "Average_Rainfall", type: "quantitative" },
              color: { field: "Region", type: "nominal" },
              tooltip: [
                { field: "year", type: "quantitative", title: "Year" },
                { field: "Region", type: "nominal", title: "Region" },
                {
                  field: "Average_Rainfall",
                  type: "quantitative",
                  title: "Average Rainfall (mm)",
                  format: ".2f",
                },
              ],
            }
          },
          {
            data: { values: [{ "year": 2019 }] },
            mark: {
              type: "rule",
              stroke: "red",
              strokeDash: [5, 5],
              size: 2,
            },
            encoding: {
              x: { field: "year", type: "quantitative" },
            },
          },
          {
            data: { values: [{"year": 2019, "Average_Rainfall": 1000}] },
            mark: {
              type: "text",
              align: "right",
              baseline: "bottom",
              dx: -15,
              fontSize: 14,
              text: [
                "Many weather station closed due to covid 19,",
                "leading to missing/wrong data"
              ]
            },
            encoding: {
              x: { field: "year", type: "quantitative" },
              y: { field: "Average_Rainfall", type: "quantitative"}
            }
          }
        ],
      };
      vegaEmbed("#vis_multiline_density", spec_multiline_rainfall, {
        actions: false,
      });

      const spec_barchart_damage = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        width: 400,
        height: 500,
        data: { url: "cleaned_disaster_data.csv" },
        transform: [
          {
            filter:
              "datum['Total Damage (1K USD)'] != null && datum['Total Damage (1K USD)'] > 0",
          },
          {
            aggregate: [
              { op: "sum", field: "Total Damage (1K USD)", as: "total_damage" },
            ],
            groupby: ["YEAR"],
          },
          {
            window: [{ op: "max", field: "total_damage", as: "max_damage" }],
            frame: [null, null],
          },
        ],
        encoding: {
          x: { field: "YEAR", type: "ordinal", title: "Year", axis: { titleFontSize: 16, labelFontSize: 14 } },
          y: {
            field: "total_damage",
            type: "quantitative",
            title: "Total Damage (in 1000 USD)",
            axis: { titleFontSize: 16, labelFontSize: 14 },
            scale: { padding: 20 },
          },
          tooltip: [
            { field: "YEAR", type: "ordinal" },
            {
              field: "total_damage",
              type: "quantitative",
              title: "Total Damage (1k USD)",
              format: ",.0f",
            },
          ],
        },
        layer: [
          {
            mark: "bar",
            encoding: {
              color: {
                condition: {
                  test: "datum.total_damage === datum.max_damage",
                  value: "black",
                },
                value: "steelblue",
              },
            },
          },
          {
            mark: {
              type: "text",
              align: "center",
              baseline: "bottom",
              dy: -5,
            },
            encoding: {
              text: {
                field: "total_damage",
                type: "quantitative",
                format: ".2s",
              },
              color: { value: "black" },
            },
          },
          {
            "transform": [
              { "filter": "datum.YEAR == 2007" }
            ],
            "mark": {
              "type": "text",
              "align": "left",
              "baseline": "top",
              "dx": 40,
              "dy": 0,
              "fontSize": 14,
              "text": [
                "In 2007, Malaysia suffered severe floods,",
                "mostly in Johor, killing dozens,",
                "displacing thousands, and",
                "causing massive infrastructure damage."
              ]
            }
          }
        ],
      };
      vegaEmbed("#vis_barchart_damage", spec_barchart_damage, {
        actions: false,
      });
    </script>
  </body>
</html>

