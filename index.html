<!doctype html>
<html>

<head>
  <title>Malaysia Rainfall Data</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f4f4f4;
      color: #333;
    }

    /* Main dashboard container using CSS Grid */
    .dashboard-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      /* Two equal columns */
      gap: 20px;
      /* Space between grid cells */
      width: 90%;
      max-width: 1600px;
      margin: 20px auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .grid-item {
      padding: 15px;
      text-align: center;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    /* Class for cells that span the full width */
    .full-width {
      grid-column: 1 / -1;
      /* Span across both columns */
    }

    /* Styles for different row types as requested */
    .thin-cell {
      border-width: 1px;
      padding: 10px;
    }

    .thick-cell {
      border-width: 2px;
      padding: 20px;
    }

    /* Dashboard Title styling */
    h1 {
      font-family: 'serif';
      font-size: 2.5em;
      margin: 0;
    }

    /* Styling for the information text block */
    .info-text {
        text-align: left;
        padding: 10px;
        font-size: 1.1em;
        line-height: 1.6;
    }

    .source {
      text-align: center;
      font-size: small;
      margin-top: 20px;
      padding-bottom: 20px;
    }
  </style>
</head>

<body>

  <div class="dashboard-container">

    <div class="grid-item full-width thin-cell">
      <h1>Malaysia Rainfall and Disaster Data Dashboard</h1>
    </div>

    <div class="grid-item full-width thick-cell">
      <div id="vis_map"></div>
      <div>
        <label for="year_slider_map">Year: </label>
        <input id="year_slider_map" type="range" min="2000" max="2021" step="1" value="2000" />
        <span id="year_label_map">2000</span>
      </div>
    </div>

    <div class="grid-item thick-cell">
      <div id="vis_donut"></div>
      <div>
        <label for="year_slider_donut">Year: </label>
        <input id="year_slider_donut" type="range" min="2000" max="2021" step="1" value="2000" />
        <span id="year_label_donut">2000</span>
      </div>
    </div>

    <div class="grid-item thick-cell">
      <div id="vis_lollipop"></div>
    </div>

    <div class="grid-item thick-cell">
        <div class="info-text">
            <h2>Key Insights ðŸ’¡</h2>
            <p>
                This dashboard presents an analysis of rainfall patterns and their correlation with natural disasters in Malaysia from 2000 to 2021.
                <br><br>
                The choropleth map visualizes the geographical distribution of annual rainfall. Higher rainfall is often concentrated in the eastern coastal states, especially during the monsoon season.
                <br><br>
                The charts explore the types of disasters, total affected population, and a comparison between rainfall in East and West Malaysia.
            </p>
        </div>
    </div>

    <div class="grid-item thick-cell">
      <div id="vis_multiline_density"></div>
    </div>

  </div> <div class="source">
    Source:
    <a href="https://www.kaggle.com/datasets/rajatjurel/malaysia-flood-dataset2000-2010/data">Kaggle Malaysia Flood Dataset (2000-2010)</a>
  </div>

  <script type="text/javascript">
    // Map visualization
    const spec_map = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      title: {
        text: "Annual Rainfall in Malaysia",
        font: "serif",
        fontSize: 24,
        anchor: "middle",
        frame: "bounds",
        subtitle: {
          expr: "year_selection"
        },
      },
      width: "container",
      height: 500,
      background: "#e6f7ff",
      projection: {
        type: "mercator",
        scale: 2000,
        center: [109, 4.5],
      },
      params: [{
        name: "year_selection",
        value: 2000,
      }, ],
      layer: [{
        data: {
          url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/countries-10m.json",
          format: {
            type: "topojson",
            feature: "countries"
          },
        },
        transform: [{
          filter: {
            field: "properties.name",
            oneOf: [
              "Singapore",
              "Laos",
              "Thailand",
              "Cambodia",
              "Indonesia",
              "Philippines",
              "Brunei Darussalam",
              "Myanmar",
            ],
          },
        }, ],
        mark: {
          type: "geoshape",
          fill: "lightgray",
          stroke: "black"
        },
      }, {
        data: {
          url: "ne_10m_admin_1_states_provinces.json",
          format: {
            type: "topojson",
            feature: "ne_10m_admin_1_states_provinces",
          },
        },
        mark: {
          type: "geoshape",
          fill: "lightgray",
          stroke: "white"
        },
      }, {
        data: {
          url: "processed_rainfall_data.csv"
        },
        transform: [{
          filter: "datum.YEAR == year_selection"
        }, {
          lookup: "STATE",
          from: {
            data: {
              url: "ne_10m_admin_1_states_provinces.json",
              format: {
                type: "topojson",
                feature: "ne_10m_admin_1_states_provinces",
              },
            },
            key: "properties.name",
          },
          as: "geo",
        }, {
          filter: "datum.geo != null"
        }, ],
        mark: {
          type: "geoshape"
        },
        encoding: {
          shape: {
            field: "geo",
            type: "geojson"
          },
          color: {
            field: "ANNUAL RAINFALL",
            type: "quantitative",
            scale: {
              scheme: "blues",
              reverse: false
            },
            legend: {
              title: "Annual Rainfall (mm)"
            },
          },
          tooltip: [{
            field: "STATE",
            type: "nominal",
            title: "State"
          }, {
            field: "ANNUAL RAINFALL",
            type: "quantitative",
            title: "Annual Rainfall (mm)",
            format: ".2f",
          }, {
            field: "NUMBER OF DAYS OF RAINFALL",
            type: "quantitative",
            title: "Days of rainfall",
          }, ],
        },
      }, {
        data: {
          url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/ne_110m_graticules_1.json",
          format: {
            type: "topojson",
            feature: "ne_110m_graticules_1"
          },
        },
        mark: {
          type: "geoshape",
          fill: "none",
          stroke: "#E0E0E0",
          strokeOpacity: 0.5,
          interactive: false,
        },
      }, ],
    };
    vegaEmbed('#vis_map', spec_map, {
      renderer: 'svg'
    }).then(result => {
      const view = result.view;
      const slider = document.getElementById('year_slider_map');
      const label = document.getElementById('year_label_map');

      slider.addEventListener('input', () => {
        const year = parseInt(slider.value, 10);
        label.innerText = year;

        const previousData = new Map(
          d3.select(view.container()).selectAll('.mark-geoshape.role-mark path').nodes()
          .map(node => [node.__data__.datum.STATE, node.getAttribute('fill')])
        );

        view.signal('year_selection', year).runAsync().then(() => {
          const paths = d3.select(view.container()).selectAll('.mark-geoshape.role-mark path');

          paths.each(function(d) {
            const previousFill = previousData.get(d.datum.STATE);
            if (previousFill) {
              d3.select(this).attr('fill', previousFill);
            }
          });

          paths.transition().duration(500).attr('fill', d => d.fill);
        });
      });
    });

    const spec_donut = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      title: "Disaster Subtypes",
      width: "container",
      height: 300,
      data: {
        url: "cleaned_disaster_data.csv"
      },
      params: [{
        name: "year_selection",
        value: 2000,
      }, ],
      layer: [{
        transform: [{
          filter: "datum.YEAR == year_selection"
        }, {
          calculate: "isValid(datum.Origin) && datum.Origin !== '' ? datum.Origin : 'No data'",
          as: "origin_tooltip",
        }, {
          calculate: "isValid(datum['Total Affected']) ? datum['Total Affected'] : 'No data'",
          as: "affected_tooltip",
        }, {
          calculate: "isValid(datum['Total Deaths']) ? datum['Total Deaths'] : 'No data'",
          as: "deaths_tooltip",
        }, ],
        mark: {
          type: "arc",
          innerRadius: 80
        },
        encoding: {
          theta: {
            aggregate: "count",
            type: "quantitative"
          },
          color: {
            field: "Disaster Subtype",
            type: "nominal",
            scale: {
              domain: [
                'Infectious disease (General)', 'Storm (General)', 'Viral disease',
                'Flash flood', 'Water', 'Flood (General)', 'Riverine flood',
                'Landslide (wet)', 'Lightning/Thunderstorms', 'Tsunami', 'Forest fire',
                'Drought', 'Ground movement'
              ],
              scheme: "category10",
            },
            legend: {
              title: "Disaster Type"
            },
          },
          tooltip: [{
            field: "Disaster Subtype",
            type: "nominal",
            title: "Disaster Type",
          }, {
            field: "origin_tooltip",
            type: "nominal",
            title: "Origin"
          }, {
            field: "affected_tooltip",
            type: "nominal",
            title: "Total Affected",
          }, {
            field: "deaths_tooltip",
            type: "nominal",
            title: "Total Deaths",
          }, ],
        },
      }, {
        data: {
          url: "cleaned_disaster_data.csv"
        },
        transform: [{
          filter: "datum.YEAR == year_selection"
        }, {
          aggregate: [{
            op: "count",
            as: "disaster_count"
          }]
        }, {
          calculate: "datum.disaster_count > 0 ? year_selection : 'No data'",
          as: "display_text",
        }, {
          calculate: "datum.disaster_count > 0 ? 40 : 16",
          as: "font_size",
        }, ],
        mark: {
          type: "text",
          fontSize: {
            expr: "datum.font_size"
          },
          fontWeight: "bold",
        },
        encoding: {
          text: {
            field: "display_text",
            type: "nominal"
          },
        },
      }, {
        data: {
          url: "cleaned_disaster_data.csv"
        },
        transform: [{
          filter: "datum.YEAR == year_selection"
        }, {
          aggregate: [{
            op: "count",
            as: "disaster_count"
          }]
        }, {
          filter: "datum.disaster_count == 0"
        }, {
          calculate: "'for ' + year_selection",
          as: "subtitle_text"
        }, ],
        mark: {
          type: "text",
          dy: 20,
          fontSize: 14,
          color: "gray",
        },
        encoding: {
          text: {
            field: "subtitle_text",
            type: "nominal"
          },
        },
      }, ],
    };
    vegaEmbed('#vis_donut', spec_donut, {
      renderer: 'svg'
    }).then(result => {
      const view = result.view;
      const slider = document.getElementById('year_slider_donut');
      const label = document.getElementById('year_label_donut');

      slider.addEventListener('input', () => {
        const year = parseInt(slider.value, 10);
        label.innerText = year;
        view.signal('year_selection', year).runAsync();
      });
    });

    const spec_lollipop = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "title": "Total Annual Rainfall in Malaysia (2000 - 2021)",
      "width": "container",
      "height": 300,
      "data": {
        "url": "processed_rainfall_data.csv"
      },
      "transform": [{
        "aggregate": [{
          "op": "sum",
          "field": "ANNUAL RAINFALL",
          "as": "total_rainfall"
        }],
        "groupby": ["YEAR"]
      }],
      "encoding": {
        "y": {
          "field": "YEAR",
          "type": "ordinal",
          "title": "Year",
          "axis": {
            "grid": false
          }
        },
        "x": {
          "field": "total_rainfall",
          "type": "quantitative",
          "title": "Total Annual Rainfall (mm)",
          "axis": {
            "grid": true
          }
        }
      },
      "layer": [{
        "mark": "rule"
      }, {
        "mark": {
          "type": "point",
          "filled": true,
          "size": 100
        },
        "encoding": {
          "tooltip": [{
            "field": "YEAR",
            "type": "ordinal",
            "title": "Year"
          }, {
            "field": "total_rainfall",
            "type": "quantitative",
            "title": "Total Rainfall (mm)",
            "format": ".2f"
          }]
        }
      }]
    };
    vegaEmbed("#vis_lollipop", spec_lollipop, {
      actions: false
    });

    const spec_multiline_rainfall = {
      "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
      "title": "Avg. Annual Rainfall in East vs West Malaysia (2000-2021)",
      "width": "container",
      "height": 300,
      "data": {
        "url": "cleaned_east_west.csv"
      },
      "transform": [{
        "fold": ["West_Avg_Rainfall", "East_Avg_Rainfall"],
        "as": ["Region", "Average_Rainfall"]
      }, {
        "calculate": "datum.Region == 'West_Avg_Rainfall' ? 'West Malaysia' : 'East Malaysia'",
        "as": "Region"
      }],
      "mark": "line",
      "encoding": {
        "x": {
          "field": "year",
          "type": "ordinal",
          "title": "Year"
        },
        "y": {
          "field": "Average_Rainfall",
          "type": "quantitative",
          "title": "Average Annual Rainfall (mm)"
        },
        "color": {
          "field": "Region",
          "type": "nominal",
          "title": "Region"
        },
        "tooltip": [{
          "field": "year",
          "type": "ordinal",
          "title": "Year"
        }, {
          "field": "Region",
          "type": "nominal",
          "title": "Region"
        }, {
          "field": "Average_Rainfall",
          "type": "quantitative",
          "title": "Average Rainfall (mm)",
          "format": ".2f"
        }]
      }
    };
    vegaEmbed("#vis_multiline_density", spec_multiline_rainfall, {
      actions: false
    });
  </script>
</body>

</html>
