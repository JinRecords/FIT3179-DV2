<!doctype html>
<html>
  <head>
    <title>Malaysia Rainfall Data</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body { font-family: sans-serif; background: #fafafa; }
      .vis-container {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }
      .source {
        text-align: center;
        font-size: small;
      }
    </style>
  </head>
  <body>
    <div class="vis-container">
      <div id="vis_map"></div>
    </div>
    <div class="vis-container">
      <label for="year_slider_map">Year: </label>
      <input id="year_slider_map" type="range" min="2000" max="2021" step="1" value="2000" />
      <span id="year_label_map">2000</span>
    </div>
    <div class="vis-container">
      <div id="vis_donut"></div>
    </div>
    <div class="vis-container">
      <label for="year_slider_donut">Year: </label>
      <input id="year_slider_donut" type="range" min="2000" max="2021" step="1" value="2000" />
      <span id="year_label_donut">2000</span>
    </div>

    <div class="vis-container">
      <div id="vis_lollipop"></div>
    </div>
    <div class="vis-container">
      <div id="vis_area"></div>
    </div>
    <div class="vis-container">
      <div id="vis_multiline_density"></div>
    </div>
    <div class="source">
      Source:
      <a
        href="https://www.kaggle.com/datasets/rajatjurel/malaysia-flood-dataset2000-2010/data"
        >https://www.kaggle.com/datasets/rajatjurel/malaysia-flood-dataset2000-2010/data</a
      >
    </div>

    <script type="text/javascript">
      // =================== MAP SPEC ===================
      const spec_map = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        title: {
          text: "Annual Rainfall in Malaysia",
          font: "serif",
          fontSize: 30,
          anchor: "middle",
          frame: "bounds",
          subtitle: { expr: "year_selection" },
        },
        width: 800,
        height: 500,
        background: "#e6f7ff",
        projection: { type: "mercator", scale: 2000, center: [109, 4.5] },
        params: [{ name: "year_selection", value: 2000 }],
        layer: [
          {
            data: {
              url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/countries-10m.json",
              format: { type: "topojson", feature: "countries" },
            },
            transform: [
              {
                filter: {
                  field: "properties.name",
                  oneOf: [
                    "Singapore",
                    "Laos",
                    "Thailand",
                    "Cambodia",
                    "Indonesia",
                    "Philippines",
                    "Brunei Darussalam",
                    "Myanmar",
                  ],
                },
              },
            ],
            mark: { type: "geoshape", fill: "lightgray", stroke: "black" },
          },
          {
            data: {
              url: "ne_10m_admin_1_states_provinces.json",
              format: {
                type: "topojson",
                feature: "ne_10m_admin_1_states_provinces",
              },
            },
            mark: { type: "geoshape", fill: "lightgray", stroke: "white" },
          },
          {
            data: { url: "processed_rainfall_data.csv" },
            transform: [
              { filter: "datum.YEAR == year_selection" },
              {
                lookup: "STATE",
                from: {
                  data: {
                    url: "ne_10m_admin_1_states_provinces.json",
                    format: {
                      type: "topojson",
                      feature: "ne_10m_admin_1_states_provinces",
                    },
                  },
                  key: "properties.name",
                },
                as: "geo",
              },
              { filter: "datum.geo != null" },
            ],
            mark: { type: "geoshape" },
            encoding: {
              shape: { field: "geo", type: "geojson" },
              color: {
                field: "ANNUAL RAINFALL",
                type: "quantitative",
                scale: { scheme: "blues" },
                legend: { title: "Annual Rainfall (mm)" },
              },
              tooltip: [
                { field: "STATE", type: "nominal", title: "State" },
                {
                  field: "ANNUAL RAINFALL",
                  type: "quantitative",
                  title: "Annual Rainfall (mm)",
                  format: ".2f",
                },
                {
                  field: "NUMBER OF DAYS OF RAINFALL",
                  type: "quantitative",
                  title: "Days of rainfall",
                },
              ],
            },
          },
          {
            data: {
              url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/ne_110m_graticules_1.json",
              format: { type: "topojson", feature: "ne_110m_graticules_1" },
            },
            mark: {
              type: "geoshape",
              fill: "none",
              stroke: "#E0E0E0",
              strokeOpacity: 0.5,
              interactive: false,
            },
          },
        ],
      };

      vegaEmbed("#vis_map", spec_map, { renderer: "svg" }).then((res) => {
        const view = res.view;
        const slider = document.getElementById("year_slider_map");
        const label = document.getElementById("year_label_map");

        slider.addEventListener("input", () => {
          const year = +slider.value;
          label.innerText = year;

          // fade out, update, fade in
          const svg = d3.select(view.container()).select("svg");
          svg.transition().duration(300).style("opacity", 0.2).on("end", () => {
            view.signal("year_selection", year).runAsync().then(() => {
              svg.transition().duration(500).style("opacity", 1);
            });
          });
        });
      });

      // =================== DONUT SPEC ===================
      const spec_donut = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        title: "Disaster Subtypes",
        width: 400,
        height: 400,
        data: { url: "cleaned_disaster_data.csv" },
        params: [{ name: "year_selection", value: 2000 }],
        layer: [
          {
            transform: [{ filter: "datum.YEAR == year_selection" }],
            mark: { type: "arc", innerRadius: 80 },
            encoding: {
              theta: { aggregate: "count", type: "quantitative" },
              color: {
                field: "Disaster Subtype",
                type: "nominal",
                legend: { title: "Disaster Type" },
              },
              tooltip: [
                { field: "Disaster Subtype", title: "Disaster Type" },
                { field: "Origin", title: "Origin" },
                { field: "Total Affected", title: "Total Affected" },
                { field: "Total Deaths", title: "Total Deaths" },
              ],
            },
          },
        ],
      };

      vegaEmbed("#vis_donut", spec_donut, { renderer: "svg" }).then((res) => {
        const view = res.view;
        const slider = document.getElementById("year_slider_donut");
        const label = document.getElementById("year_label_donut");

        slider.addEventListener("input", () => {
          const year = +slider.value;
          label.innerText = year;

          // same fade-in/out trick
          const svg = d3.select(view.container()).select("svg");
          svg.transition().duration(300).style("opacity", 0.2).on("end", () => {
            view.signal("year_selection", year).runAsync().then(() => {
              svg.transition().duration(500).style("opacity", 1);
            });
          });
        });
      });

      // =================== LOLLIPOP ===================
      const spec_lollipop = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        title: "Total Annual Rainfall in Malaysia from 2000 - 2021",
        width: 800,
        height: 500,
        data: { url: "processed_rainfall_data.csv" },
        transform: [
          {
            aggregate: [
              { op: "sum", field: "ANNUAL RAINFALL", as: "total_rainfall" },
            ],
            groupby: ["YEAR"],
          },
        ],
        encoding: {
          y: { field: "YEAR", type: "ordinal", title: "Year" },
          x: {
            field: "total_rainfall",
            type: "quantitative",
            title: "Total Annual Rainfall (mm)",
          },
        },
        layer: [
          { mark: "rule" },
          {
            mark: { type: "point", filled: true, size: 100 },
            encoding: {
              tooltip: [
                { field: "YEAR", title: "Year" },
                { field: "total_rainfall", title: "Total Rainfall (mm)" },
              ],
            },
          },
        ],
      };
      vegaEmbed("#vis_lollipop", spec_lollipop, { actions: false });

      // =================== AREA ===================
      const spec_area = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        title: "Total Number of People Affected per Year",
        width: 800,
        height: 500,
        data: { url: "cleaned_disaster_data.csv" },
        transform: [
          {
            aggregate: [
              { op: "sum", field: "Total Affected", as: "total_affected" },
            ],
            groupby: ["YEAR"],
          },
        ],
        encoding: {
          x: { field: "YEAR", type: "ordinal" },
          y: {
            field: "total_affected",
            type: "quantitative",
            title: "Total Number of People Affected",
          },
        },
        layer: [{ mark: "area" }, { mark: "line" }, { mark: "point" }],
      };
      vegaEmbed("#vis_area", spec_area, { actions: false });

      // =================== MULTILINE ===================
      const spec_multiline_density = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        title: "Rainfall Density in East vs Peninsular Malaysia (2000-2021)",
        width: 800,
        height: 500,
        data: { url: "processed_rainfall_data.csv" },
        transform: [
          {
            lookup: "STATE",
            from: {
              data: { url: "state_areas.csv" },
              key: "STATE",
              fields: ["AREA_KM2"],
            },
          },
          {
            calculate:
              "datum.STATE == 'Sabah' || datum.STATE == 'Sarawak' || datum.STATE == 'Wilayah Persekutuan Labuan' ? 'East Malaysia' : 'Peninsular Malaysia'",
            as: "Region",
          },
          {
            aggregate: [
              { op: "sum", field: "ANNUAL RAINFALL", as: "total_rainfall" },
              { op: "sum", field: "AREA_KM2", as: "total_area" },
            ],
            groupby: ["YEAR", "Region"],
          },
          { calculate: "datum.total_rainfall / datum.total_area", as: "rainfall_density" },
        ],
        mark: "line",
        encoding: {
          x: { field: "YEAR", type: "ordinal" },
          y: { field: "rainfall_density", type: "quantitative", title: "Rainfall Density (mm/km²)" },
          color: { field: "Region", type: "nominal" },
          tooltip: [
            { field: "YEAR", title: "Year" },
            { field: "Region", title: "Region" },
            { field: "rainfall_density", title: "Rainfall Density (mm/km²)", format: ".4f" },
          ],
        },
      };
      vegaEmbed("#vis_multiline_density", spec_multiline_density, { actions: false });
    </script>
  </body>
</html>
