<!doctype html>
<html>
  <head>
    <title>Malaysia Rainfall Data</title>
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.2.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.20.8"></script>
    <style>
      .vis-container {
        display: flex;
        justify-content: center;
        margin-bottom: 20px;
      }
      .source {
        text-align: center;
        font-size: small;
      }
    </style>
  </head>
  <body>
    <div class="vis-container">
      <div id="vis_map"></div>
    </div>
    <div class="vis-container">
      <div id="vis_donut"></div>
    </div>

    <div class="source">
      Source:
      <a
        href="https://www.kaggle.com/datasets/rajatjurel/malaysia-flood-dataset2000-2010/data"
        >https://www.kaggle.com/datasets/rajatjurel/malaysia-flood-dataset2000-2010/data</a
      >
    </div>
    <script type="text/javascript">
      // Map visualization
      const spec_map = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        title: {
          text: "Annual Rainfall in Malaysia",
          font: "serif",
          fontSize: 30,
          anchor: "middle",
          frame: "bounds",
          subtitle: { expr: "year_selection" },
        },
        width: 800,
        height: 500,
        background: "#e6f7ff",
        projection: {
          type: "mercator",
          scale: 2000,
          center: [109, 4.5],
        },
        params: [
          {
            name: "year_selection",
            value: 2010,
            bind: {
              input: "range",
              min: 2000,
              max: 2021,
              step: 1,
              name: "Year",
            },
          },
        ],
        layer: [
          {
            data: {
              url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/countries-10m.json",
              format: { type: "topojson", feature: "countries" },
            },
            transform: [
              {
                filter: {
                  field: "properties.name",
                  oneOf: [
                    "Singapore",
                    "Laos",
                    "Thailand",
                    "Cambodia",
                    "Indonesia",
                    "Philippines",
                    "Brunei Darussalam",
                    "Myanmar",
                  ],
                },
              },
            ],
            mark: { type: "geoshape", fill: "lightgray", stroke: "black" },
          },
          {
            data: {
              url: "ne_10m_admin_1_states_provinces.json",
              format: {
                type: "topojson",
                feature: "ne_10m_admin_1_states_provinces",
              },
            },
            mark: { type: "geoshape", fill: "lightgray", stroke: "white" },
          },
          {
            data: { url: "processed_rainfall_data.csv" },
            transform: [
              { filter: "datum.YEAR == year_selection" },
              {
                lookup: "STATE",
                from: {
                  data: {
                    url: "ne_10m_admin_1_states_provinces.json",
                    format: {
                      type: "topojson",
                      feature: "ne_10m_admin_1_states_provinces",
                    },
                  },
                  key: "properties.name",
                },
                as: "geo",
              },
              { filter: "datum.geo != null" },
            ],
            mark: { type: "geoshape" },
            encoding: {
              shape: { field: "geo", type: "geojson" },
              color: {
                field: "ANNUAL RAINFALL",
                type: "quantitative",
                scale: { scheme: "blues", reverse: false },
                legend: { title: "Annual Rainfall (mm)" },
              },
              tooltip: [
                { field: "STATE", type: "nominal", title: "State" },
                {
                  field: "ANNUAL RAINFALL",
                  type: "quantitative",
                  title: "Annual Rainfall (mm)",
                  format: ".2f",
                },
                {
                  field: "NUMBER OF DAYS OF RAINFALL",
                  type: "quantitative",
                  title: "Days of rainfall",
                },
              ],
            },
          },
          {
            data: {
              url: "https://jinrecords.github.io/FIT3179-Vega-lite-hw/ne_110m_graticules_1.json",
              format: { type: "topojson", feature: "ne_110m_graticules_1" },
            },
            mark: {
              type: "geoshape",
              fill: "none",
              stroke: "#E0E0E0",
              strokeOpacity: 0.5,
              interactive: false,
            },
          },
        ],
      };
      vegaEmbed("#vis_map", spec_map, { actions: false });

      const spec_donut = {
        $schema: "https://vega.github.io/schema/vega-lite/v5.json",
        title: "Disaster Subtypes",
        width: 400,
        height: 400,
        data: { url: "cleaned_disaster_data.csv" },
        params: [
          {
            name: "year_selection",
            value: 2010,
            bind: {
              input: "range",
              min: 2000,
              max: 2025,
              step: 1,
              name: "Year",
            },
          },
        ],
        layer: [
          {
            transform: [
              { filter: "datum.YEAR == year_selection" },
              {
                calculate:
                  "isValid(datum.Origin) && datum.Origin !== '' ? datum.Origin : 'No data'",
                as: "origin_tooltip",
              },
              {
                calculate:
                  "isValid(datum['Total Affected']) ? datum['Total Affected'] : 'No data'",
                as: "affected_tooltip",
              },
              {
                calculate:
                  "isValid(datum['Total Deaths']) ? datum['Total Deaths'] : 'No data'",
                as: "deaths_tooltip",
              },
            ],
            mark: { type: "arc", innerRadius: 80 },
            encoding: {
              theta: { aggregate: "count", type: "quantitative" },
              color: {
                field: "Disaster Subtype",
                type: "nominal",
                scale: {
                  domain: [
                    "Flash flood",
                    "Flood (General)",
                    "Riverine flood",
                    "Landslide (wet)",
                    "Drought",
                  ],
                  scheme: "category10",
                },
                legend: { title: "Disaster Type" },
              },
              tooltip: [
                {
                  field: "Disaster Subtype",
                  type: "nominal",
                  title: "Disaster Type",
                },
                { field: "origin_tooltip", type: "nominal", title: "Origin" },
                {
                  field: "affected_tooltip",
                  type: "nominal",
                  title: "Total Affected",
                },
                {
                  field: "deaths_tooltip",
                  type: "nominal",
                  title: "Total Deaths",
                },
              ],
            },
          },
          {
            data: { url: "cleaned_disaster_data.csv" },
            transform: [
              { filter: "datum.YEAR == year_selection" },
              { aggregate: [{ op: "count", as: "disaster_count" }] },
              {
                calculate:
                  "datum.disaster_count > 0 ? year_selection : 'No data'",
                as: "display_text",
              },
              {
                calculate: "datum.disaster_count > 0 ? 40 : 16",
                as: "font_size",
              },
            ],
            mark: {
              type: "text",
              fontSize: { expr: "datum.font_size" },
              fontWeight: "bold",
            },
            encoding: {
              text: { field: "display_text", type: "nominal" },
            },
          },
          {
            data: { url: "cleaned_disaster_data.csv" },
            transform: [
              { filter: "datum.YEAR == year_selection" },
              { aggregate: [{ op: "count", as: "disaster_count" }] },
              { filter: "datum.disaster_count == 0" },
              { calculate: "'for ' + year_selection", as: "subtitle_text" },
            ],
            mark: {
              type: "text",
              dy: 20,
              fontSize: 14,
              color: "gray",
            },
            encoding: {
              text: { field: "subtitle_text", type: "nominal" },
            },
          },
        ],
      };
      vegaEmbed("#vis_donut", spec_donut, { actions: false });
    </script>
  </body>
</html>
